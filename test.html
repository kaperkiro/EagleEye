<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Stream Test</title>
</head>
<body>
  <h2>WebRTC Stream Test</h2>
  <video id="video" autoplay playsinline style="max-width: 50%;"></video>
  <p id="status">Connecting...</p>
  <script>
    const video = document.getElementById("video");
    const status = document.getElementById("status");
    const ws = new WebSocket("ws://localhost:8000/ws");
    const pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    pc.addTransceiver("video", { direction: "recvonly" });

    ws.onopen = () => {
      console.log("WebSocket connected");
      status.textContent = "Connected, negotiating...";
      startOffer();
    };

    ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    console.log("Received:", JSON.stringify(data, null, 2));
    if (data.type === "answer") {
      pc.setRemoteDescription(new RTCSessionDescription(data))
        .then(() => {
          console.log("Remote description set");
          status.textContent = "Streaming";
        })
        .catch(e => console.error("Set remote description failed:", e));
    } else if (data.type === "error") {
      status.textContent = `Error: ${data.message}`;
    } else {
      console.log("Unexpected message:", data);
    }
  };

  pc.oniceconnectionstatechange = () => {
    console.log("ICE connection state:", pc.iceConnectionState);
  };

    ws.onerror = (error) => {
      console.error("WebSocket error:", error);
      status.textContent = "Connection error";
    };

    ws.onclose = (event) => {
      console.log("WebSocket closed:", event.code, event.reason);
      status.textContent = "Disconnected";
    };

    pc.onicecandidate = (event) => {
      if (event.candidate) {
        console.log("ICE candidate:", event.candidate);
        ws.send(JSON.stringify({ type: "candidate", candidate: event.candidate.toJSON() }));
      }
    };

    pc.ontrack = (event) => {
      console.log("Video track received:", event.streams[0]);
      video.srcObject = event.streams[0];
      video.play().catch(e => console.error("Video play failed:", e));
    };

    pc.onconnectionstatechange = () => {
      console.log("Connection state:", pc.connectionState);
    };

    async function startOffer() {
      try {
        const offer = await pc.createOffer();
        console.log("Offer created:", offer.sdp);
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({ type: "offer", sdp: offer.sdp }));
      } catch (e) {
        console.error("Offer failed:", e);
        status.textContent = `Offer failed: ${e}`;
      }
    }
  </script>
</body>
</html>